#!/usr/bin/bash

set -euo pipefail

echo "Checkingout master.."
git checkout master

echo "-----1"
git pull

echo "-----2"
git status

build=$(mvn -q -Dexec.executable=echo -Dexec.args='target/${project.artifactId}-${project.version}.${project.packaging}' --non-recursive exec:exec)
echo "Build to generate: ${build}"

echo "Creating build.."
mvn -B release:clean && mvn -B release:prepare && mvn -B release:perform

echo "-----3"
git status

echo "Calling terraform.."
terraform init && terraform apply -auto-approve -var "build=${build}"